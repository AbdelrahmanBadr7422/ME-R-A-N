<%- include('header') %>

<div class="container mt-4">
  <h2>Courses</h2>

  <div id="messageContainer" class="mt-2"></div>

  <form id="courseForm" onsubmit="addCourse(event)">
    <div class="form-group">
      <label for="courseName">Course Name</label>
      <input id="courseName" class="form-control" name="name" placeholder="Course Name" required />
    </div>

    <div class="form-group mt-2">
      <label for="code">Course Code</label>
      <input id="code" class="form-control" name="code" placeholder="Course Code" required />
    </div>

    <div class="form-group mt-2">
      <label for="dept">Department</label>
      <select id="dept" class="form-control" name="department" required>
        <option value="">Select Department</option>
        <% departmentsList.forEach(dep => { %>
          <option value="<%= dep._id %>"><%= dep.name %></option>
        <% }) %>
      </select>
    </div>

    <button class="btn btn-primary mt-3" type="submit">Add Course</button>
  </form>

  <table class="table table-bordered table-striped mt-4">
    <thead class="thead-dark">
      <tr>
        <th>Name</th>
        <th>Code</th>
        <th>Department</th>
      </tr>
    </thead>
    <tbody id="coursesTableBody">
      <% courseList.forEach(c => { %>
        <tr>
          <td><%= c.name %></td>
          <td><%= c.code %></td>
          <td><%= c.department?.name || 'N/A' %></td>
        </tr>
      <% }) %>
    </tbody>
  </table>
</div>

<script>
  async function addCourse(event) {
    event.preventDefault();

    const name = document.getElementById('courseName').value.trim();
    const code = document.getElementById('code').value.trim();
    const departmentId = document.getElementById('dept').value;
    const messageContainer = document.getElementById('messageContainer');

    messageContainer.innerHTML = '';

    if (!name || !code || !departmentId) {
      messageContainer.innerHTML = `<div class="alert alert-danger">Please fill in all fields.</div>`;
      return;
    }

    try {
      const response = await fetch('/api/courses', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ name, code, department: departmentId })
      });

      const result = await response.json();

      if (!response.ok) {
        throw new Error(result.message || 'Failed to add course');
      }

      const tableBody = document.getElementById('coursesTableBody');
      const newRow = document.createElement('tr');
      newRow.innerHTML = `
        <td>${result.name}</td>
        <td>${result.code}</td>
        <td>${result.department?.name || 'N/A'}</td>
      `;
      tableBody.appendChild(newRow);

      document.getElementById('courseForm').reset();
      document.getElementById('courseName').focus();

      messageContainer.innerHTML = `<div class="alert alert-success">Course added successfully!</div>`;
    } catch (error) {
      console.error(error);
      messageContainer.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
    }
  }
</script>
